<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=${Device.width}, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script
      src="https://pdt.payment.amadeus.com/checkout/sdk/5.5.0/sdk-es2015.js"
      integrity="sha384-Q4LWyrGNumhG9+LsDicEVazw8ka/CKtJIs1YocZy9zZErJfdaoVRS0e7hwEsjTA0"
      crossorigin="anonymous"
    ></script>
    <link
      rel="stylesheet"
      href="https://pdt.payment.amadeus.com/checkout/sdk/5.5.0/sdk.css"
      integrity="sha384-JzbART2wYByIVIksv7crywpToOy96QO4CCu6v/CKJz8tJFJTLT/R7NW1lj5vyLSR"
      crossorigin="anonymous"
    />
    <title>Outpayce Checkout SDK - Basic HTML Integration</title>
    <style>
        #pay-button {
            display: none;
            padding: 12px 24px;
            font-size: 16px;
            font-weight: bold;
            text-align: center;
            text-decoration: none;
            border: 2px solid #4CAF50;
            color: #fff;
            background-color: #4CAF50;
            border-radius: 6px;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
            cursor: pointer;
        }
        .pay-button:hover {
            background-color: #fff;
            color: #4CAF50;
        }
        .pay-button:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
    <div id="payment-form-container"></div>
    <button id="pay-button" onclick="pay()">Pay</button>

    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const ppid = urlParams.get("ppid");

      const pnr_number = urlParams.get("pnr_number");

      document.getElementById("output").textContent = ppid
        ? `PPID: ${ppid}`
        : "Không có ppid trong URL";


        document.getElementById("output").textContent = pnr_number
        ? `pnr_number: ${pnr_number}`
        : "Không có pnr_number trong URL";


    </script>
</body>
<script>

    
    var environment = 'pdt';

    var SDKConfiguration = {
        container: 'payment-form-container',
        ppid,
        environment,
        locale: 'en-GB',
        options: {}
    }
    var checkout = new AmadeusCheckout(SDKConfiguration);

    checkout.onReady = function (mopsList, sessionTimeout) {
         window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'onReady',
            mopsList, sessionTimeout
          }))
        document.getElementById("pay-button").style.display = "inline";
    };

    checkout.onSuccess = function (mainMopId, successData) {
        if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
              window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'success',
            mainMopId, successData
          }))
        }
    };

     checkout.onError = function(mopId, errorDetails) {
        // Called on failure or on error
          if (window.ReactNativeWebView && window.ReactNativeWebView.postMessage) {
          window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'error',
            mopId: mopId,
            errorDetails: errorDetails
          }))
         
        }
    };

    checkout.onChange = function(change) {
        // Called when there is a change on: the selected method, the fees, the card bin or the validity of the form
        //This method is deprecated and will be replaced by onPaymentMethodsChange
         window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'onChange',
            change: change
          }))
    };

    checkout.onPaymentMethodsChange = function(change) {
        // Called when there is a change on: the selected methods of payment, the fees, the cards bin or the validity of the form
        // replace the deprecated onChange method
         window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'onPaymentMethodsChange',
            change: change
          }))
    };

    checkout.onRedirectionNeeded = function(mopId, redirectionRequest) {
        // Called before the SDK redirects the user to an external page
         window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'onRedirectionNeeded',
            mopId, redirectionRequest
          }))
    }


    checkout.delegateServerCall = async function(actionTokenList, delegationType) {
        // Called when there is a payment transaction that is delegated to calling application.
        // For standard integrations this callback can be ignored.
            window.ReactNativeWebView.postMessage(JSON.stringify({
            type: 'delegateServerCall',
            actionTokenList, delegationType
          }))
    const selectedMopsDapiFormat = actionTokenList.map((mopListElement) => {
      console.log("🚀 ~ mopListElement:", mopListElement)
      return {
        pnr_number,
        "last_name": "An",
        ppid,
        "action_token": mopListElement.actionToken,
        "payment_type": "CheckoutFormPayment",
        "payment_notification": {
          "email": "ANNN@SUNGROUP.COM.VN",
          "contact_id": "OT2",
          "layout_id": "RFXSPACN",
          "lang": "VI"
        }
      }
    });

    try {
      if (delegationType === 'CreateFop') {
        dapiQueryResult = await fetch('https://dev-mobile-api-spa.sungroup.com.vn/booking/normal/payment/record', {
          method: 'POST',
          body: JSON.stringify(selectedMopsDapiFormat[0]),
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json, */*",
          }
        })

        return Promise.resolve();

      }
     else if (delegationType === 'ValidateFop') {
      dapiQueryResult = await fetch('https://dev-mobile-api-spa.sungroup.com.vn/booking/normal/payment/record/confirmation', {
          method: 'POST',
          body: JSON.stringify(selectedMopsDapiFormat[0]),
          headers: {
            "Content-Type": "application/json",
            "Accept": "application/json, */*",
          }
        })
        return Promise.resolve();
      }
    } catch (error) {
      console.log(error);
    }

    };

    

    // Start the SDK
    checkout.start();

    function pay() {
        checkout.pay();
    }
</script>
</html>
